<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focal Point</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #555;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        .hidden-view {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans transition-colors duration-300">

    <!-- Auth View (Login/Register) -->
    <div id="auth-view" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="flex items-center justify-center gap-2 text-2xl font-bold text-gray-800 dark:text-white mb-8">
                <i class="fa-solid fa-bullseye text-blue-500"></i>
                <span>Focal Point</span>
            </div>

            <!-- Login Form -->
            <div id="login-container">
                <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-white mb-6">Welcome Back!</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                            <input id="login-email" type="email" placeholder="you@example.com" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg" required>
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                            <input id="login-password" type="password" placeholder="••••••••" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg" required>
                        </div>
                        <button type="submit" class="w-full py-3 px-4 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">Login</button>
                    </form>
                    <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-6">
                        Don't have an account? <button id="show-register-btn" class="font-semibold text-blue-500 hover:underline">Sign up</button>
                    </p>
                </div>
            </div>

            <!-- Register Form -->
            <div id="register-container" class="hidden">
                 <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl">
                    <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-white mb-6">Create Account</h2>
                    <form id="register-form">
                        <div class="mb-4">
                            <label for="register-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                            <input id="register-email" type="email" placeholder="you@example.com" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg" required>
                        </div>
                        <div class="mb-6">
                            <label for="register-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                            <input id="register-password" type="password" placeholder="•••••••• (min. 6 characters)" class="w-full p-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg" required>
                        </div>
                        <button type="submit" class="w-full py-3 px-4 rounded-lg bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">Register</button>
                    </form>
                    <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-6">
                        Already have an account? <button id="show-login-btn" class="font-semibold text-blue-500 hover:underline">Login</button>
                    </p>
                </div>
            </div>
            <p id="auth-error" class="text-center text-red-500 mt-4 h-4"></p>
        </div>
    </div>
    
    <!-- Main App View (hidden until logged in) -->
    <div id="app-view" class="hidden-view">
        <!-- App Header -->
        <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-4">
                       <div class="flex items-center gap-2 text-xl font-bold text-gray-800 dark:text-white">
                            <i class="fa-solid fa-bullseye text-blue-500"></i>
                            <span>Focal Point</span>
                        </div>
                         <div class="hidden md:flex items-center space-x-1">
                            <button id="nav-tasks" class="px-3 py-2 rounded-md text-sm font-medium">Tasks</button>
                            <button id="nav-goals" class="px-3 py-2 rounded-md text-sm font-medium">Goals</button>
                        </div>
                    </div>
                     <div class="flex items-center gap-4">
                        <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fa-solid fa-moon"></i>
                        </button>
                        <button id="logout-btn" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
                 <div class="md:hidden flex items-center justify-around border-t border-gray-200 dark:border-gray-700 py-1">
                    <button id="mobile-nav-tasks" class="flex-1 py-2 text-sm font-medium">Tasks</button>
                    <button id="mobile-nav-goals" class="flex-1 py-2 text-sm font-medium">Goals</button>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-0 sm:px-6 lg:px-8 py-4">
            <div class="max-w-4xl mx-auto">
                <!-- Tasks Page -->
                <div id="tasks-view" class="hidden-view p-4 sm:p-6 md:p-8">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-6">My Tasks</h2>
                    <div class="mb-6">
                        <div id="task-view-buttons" class="flex border-b border-gray-200 dark:border-gray-700">
                            <button data-view="daily" class="task-view-btn capitalize px-4 py-2 text-sm font-semibold">daily</button>
                            <button data-view="weekly" class="task-view-btn capitalize px-4 py-2 text-sm font-semibold">weekly</button>
                            <button data-view="monthly" class="task-view-btn capitalize px-4 py-2 text-sm font-semibold">monthly</button>
                            <button data-view="uncompleted" class="task-view-btn capitalize px-4 py-2 text-sm font-semibold">uncompleted</button>
                        </div>
                    </div>
                    <form id="add-task-form" class="flex gap-2 mb-6">
                        <input id="new-task-input" type="text" class="flex-grow p-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg text-gray-800 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 transition" />
                        <button type="submit" class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors shadow hover:shadow-lg flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">Add</span>
                        </button>
                    </form>
                    <div id="task-list"></div>
                </div>

                <!-- Goals Page -->
                <div id="goals-view" class="hidden-view p-4 sm:p-6 md:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white">My Goals</h2>
                        <button id="add-goal-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors shadow hover:shadow-lg flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> <span class="hidden sm:inline">New Goal</span>
                        </button>
                    </div>
                    <div id="goal-list"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal for adding goals -->
    <div id="goal-modal" class="fixed hidden inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 justify-center items-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md m-4 transform transition-all duration-300 ease-out scale-95">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Create a New Goal</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-white transition-colors rounded-full p-1">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="add-goal-form">
                    <div class="mb-4">
                        <label for="goal-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Goal Title</label>
                        <input id="goal-title" type="text" placeholder="e.g., Learn JavaScript" class="w-full p-2 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="goal-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description (Optional)</label>
                        <textarea id="goal-description" placeholder="e.g., Build 3 projects to master it" class="w-full p-2 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg" rows="3"></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" id="cancel-modal-btn" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">Cancel</button>
                        <button type="submit" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-colors">Add Goal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAjXxLqHl5QDKmZHfhHcdik1fjGpnSCMWU",
            authDomain: "momentum-dcd4c.firebaseapp.com",
            projectId: "momentum-dcd4c",
            storageBucket: "momentum-dcd4c.appspot.com", // Corrected storage bucket
            messagingSenderId: "656981199145",
            appId: "1:656981199145:web:03449e63beda3c53628f38",
            measurementId: "G-F6EH3E4S1K"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State ---
        let userId = null;
        let tasks = [];
        let goals = [];
        let currentTaskView = 'daily';
        let currentPage = 'tasks';
        let tasksUnsubscribe = () => {};
        let goalsUnsubscribe = () => {};

        // --- DOM Elements ---
        const DOMElements = {
            authView: document.getElementById('auth-view'),
            appView: document.getElementById('app-view'),
            loginContainer: document.getElementById('login-container'),
            registerContainer: document.getElementById('register-container'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showRegisterBtn: document.getElementById('show-register-btn'),
            showLoginBtn: document.getElementById('show-login-btn'),
            authError: document.getElementById('auth-error'),
            logoutBtn: document.getElementById('logout-btn'),
            
            tasksView: document.getElementById('tasks-view'),
            goalsView: document.getElementById('goals-view'),
            taskList: document.getElementById('task-list'),
            goalList: document.getElementById('goal-list'),
            addTaskForm: document.getElementById('add-task-form'),
            newTaskInput: document.getElementById('new-task-input'),
            taskViewButtons: document.getElementById('task-view-buttons'),
            addGoalBtn: document.getElementById('add-goal-btn'),
            goalModal: document.getElementById('goal-modal'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            cancelModalBtn: document.getElementById('cancel-modal-btn'),
            addGoalForm: document.getElementById('add-goal-form'),
            
            navTasks: document.getElementById('nav-tasks'),
            navGoals: document.getElementById('nav-goals'),
            mobileNavTasks: document.getElementById('mobile-nav-tasks'),
            mobileNavGoals: document.getElementById('mobile-nav-goals'),
            themeToggle: document.getElementById('theme-toggle'),
        };

        // --- Render Functions (unchanged from previous version) ---
        const renderTasks = () => {
            const filteredTasks = filterTasks(tasks, currentTaskView);
            DOMElements.taskList.innerHTML = '';
            if (filteredTasks.length === 0) {
                DOMElements.taskList.innerHTML = `<div class="text-center py-10 px-4 bg-gray-50 dark:bg-gray-800 rounded-lg"><p class="text-gray-500 dark:text-gray-400">No ${currentTaskView} tasks here.</p></div>`;
                return;
            }
            filteredTasks.forEach(task => DOMElements.taskList.innerHTML += createTaskItemHTML(task));
        };
        
        const renderGoals = () => {
            DOMElements.goalList.innerHTML = '';
            if (goals.length === 0) {
                DOMElements.goalList.innerHTML = `<div class="text-center py-16 px-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-700">
                    <i class="fa-solid fa-bullseye text-5xl mx-auto text-gray-400 dark:text-gray-500"></i>
                    <h3 class="mt-4 text-xl font-semibold text-gray-800 dark:text-white">No Goals Yet</h3>
                    <p class="mt-1 text-gray-500 dark:text-gray-400">Click 'New Goal' to set your ambitions.</p>
                </div>`;
                return;
            }
            goals.forEach(goal => DOMElements.goalList.innerHTML += createGoalCardHTML(goal));
        };

        const createTaskItemHTML = (task) => {
            const isUncompleted = currentTaskView === 'uncompleted';
            const timestamp = new Date(task.createdAt).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const completedClass = task.isCompleted && !isUncompleted ? 'line-through text-gray-500 dark:text-gray-400' : '';
            const checkIcon = task.isCompleted ? '<i class="fa-solid fa-circle-check text-green-500 text-2xl"></i>' : '<i class="fa-regular fa-circle text-gray-400 text-2xl"></i>';

            return `
                <div class="flex items-center justify-between bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300 mb-3">
                    <div class="flex items-center gap-4 flex-grow">
                        ${!isUncompleted ? `<button data-action="toggle" data-id="${task.id}" class="focus:outline-none">${checkIcon}</button>` : '<i class="fa-solid fa-archive text-gray-400 text-xl flex-shrink-0"></i>'}
                        <div class="flex-grow">
                            <span class="text-gray-800 dark:text-gray-200 ${completedClass}">${task.text}</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex items-center gap-1">
                                <i class="fa-solid fa-clock text-xs"></i> ${isUncompleted ? 'Overdue from:' : 'Created:'} ${timestamp}
                            </p>
                        </div>
                    </div>
                    <button data-action="delete" data-id="${task.id}" class="text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full flex-shrink-0 ml-2">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            `;
        };
        
        const createGoalCardHTML = (goal) => {
            const completedMilestones = goal.milestones.filter(m => m.isCompleted).length;
            const progress = goal.milestones.length > 0 ? (completedMilestones / goal.milestones.length) * 100 : 0;
            const timestamp = new Date(goal.createdAt).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            const milestonesHTML = goal.milestones.map(createMilestoneItemHTML).join('');

            return `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 mb-6" data-goal-id="${goal.id}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-bullseye text-blue-500"></i> ${goal.title}</h3>
                            <p class="text-gray-600 dark:text-gray-400 mt-1">${goal.description}</p>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-2 flex items-center gap-1"><i class="fa-solid fa-clock text-xs"></i> Goal set on: ${timestamp}</p>
                        </div>
                        <button data-action="delete-goal" data-id="${goal.id}" class="text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-gray-600 dark:text-gray-300">Progress</span><span class="text-sm font-bold text-blue-500">${Math.round(progress)}%</span></div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div></div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-semibold text-gray-700 dark:text-gray-200 mb-2 flex items-center gap-2"><i class="fa-solid fa-flag"></i> Milestones</h4>
                        <div class="milestone-list">${milestonesHTML.length > 0 ? milestonesHTML : `<p class="text-sm text-gray-500 dark:text-gray-400 italic">No milestones yet. Add one below.</p>`}</div>
                        <form class="add-milestone-form flex gap-2 mt-3">
                            <input type="text" placeholder="Add a new milestone..." class="new-milestone-input flex-grow p-2 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg text-sm">
                            <button type="submit" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-colors"><i class="fa-solid fa-plus"></i></button>
                        </form>
                    </div>
                </div>
            `;
        };

        const createMilestoneItemHTML = (milestone) => {
            const completedClass = milestone.isCompleted ? 'line-through text-gray-500' : '';
            const checkIcon = milestone.isCompleted ? '<i class="fa-solid fa-circle-check text-green-500 text-xl"></i>' : '<i class="fa-regular fa-circle text-gray-400 text-xl"></i>';
            return `
                <div class="flex items-center justify-between pl-4 pr-2 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 mb-2">
                    <div class="flex items-center gap-3">
                        <button data-action="toggle-milestone" data-id="${milestone.id}">${checkIcon}</button>
                        <span class="text-sm text-gray-700 dark:text-gray-300 ${completedClass}">${milestone.text}</span>
                    </div>
                    <button data-action="delete-milestone" data-id="${milestone.id}" class="text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full"><i class="fa-solid fa-trash-can text-xs"></i></button>
                </div>
            `;
        };
        
        // --- Firestore Logic (adapted for user-specific data) ---
        
        const getTasksCollection = () => collection(db, `users/${userId}/tasks`);
        const getGoalsCollection = () => collection(db, `users/${userId}/goals`);
        const getMilestonesCollection = (goalId) => collection(db, `users/${userId}/goals/${goalId}/milestones`);

        const handleAddTask = async (e) => {
            e.preventDefault();
            const text = DOMElements.newTaskInput.value.trim();
            if (text === '' || currentTaskView === 'uncompleted') return;
            await addDoc(getTasksCollection(), { text, frequency: currentTaskView, isCompleted: false, createdAt: new Date().toISOString() });
            DOMElements.newTaskInput.value = '';
        };

        const handleToggleTask = async (id) => {
            const task = tasks.find(t => t.id === id);
            if (task) await updateDoc(doc(getTasksCollection(), id), { isCompleted: !task.isCompleted });
        };
        
        const handleDeleteTask = async (id) => {
            await deleteDoc(doc(getTasksCollection(), id));
        };
        
        const handleAddGoal = async (e) => {
            e.preventDefault();
            const title = document.getElementById('goal-title').value.trim();
            const description = document.getElementById('goal-description').value.trim();
            if (title === '') return;
            await addDoc(getGoalsCollection(), { title, description, createdAt: new Date().toISOString() });
            DOMElements.addGoalForm.reset();
            toggleModal(false);
        };
        
        const handleDeleteGoal = async (goalId) => {
            const milestonesSnapshot = await getDocs(getMilestonesCollection(goalId));
            const deletePromises = milestonesSnapshot.docs.map(d => deleteDoc(d.ref));
            await Promise.all(deletePromises);
            await deleteDoc(doc(getGoalsCollection(), goalId));
        };
        
        const handleAddMilestone = async (goalId, text) => {
            const newDocRef = await addDoc(getMilestonesCollection(goalId), { text, isCompleted: false, createdAt: new Date().toISOString() });
            const goalIndex = goals.findIndex(g => g.id === goalId);
            if (goalIndex !== -1) {
                const newMilestone = { id: newDocRef.id, text, isCompleted: false, createdAt: new Date().toISOString() };
                goals[goalIndex].milestones.push(newMilestone);
                goals[goalIndex].milestones.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
                renderGoals();
            }
        };
        
        const handleToggleMilestone = async (goalId, milestoneId) => {
            const goal = goals.find(g => g.id === goalId);
            const milestone = goal?.milestones.find(m => m.id === milestoneId);
            if (milestone) {
                const newCompletedState = !milestone.isCompleted;
                await updateDoc(doc(getMilestonesCollection(goalId), milestoneId), { isCompleted: newCompletedState });
                milestone.isCompleted = newCompletedState;
                renderGoals();
            }
        };
        
        const handleDeleteMilestone = async (goalId, milestoneId) => {
            await deleteDoc(doc(getMilestonesCollection(goalId), milestoneId));
            const goalIndex = goals.findIndex(g => g.id === goalId);
            if (goalIndex !== -1) {
                goals[goalIndex].milestones = goals[goalIndex].milestones.filter(m => m.id !== milestoneId);
                renderGoals();
            }
        };

        // --- Utility & Event Handlers ---
        
        const filterTasks = (tasksToFilter, view) => {
            const now = new Date();
            if (view === 'uncompleted') return tasksToFilter.filter(t => t.frequency === 'uncompleted').sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            const activeTasks = tasksToFilter.filter(t => t.frequency === view);
            switch (view) {
                case 'daily': return activeTasks.filter(t => new Date(t.createdAt).toDateString() === now.toDateString());
                case 'weekly': {
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);
                    return activeTasks.filter(t => new Date(t.createdAt) >= startOfWeek && new Date(t.createdAt) <= endOfWeek);
                }
                case 'monthly': return activeTasks.filter(t => new Date(t.createdAt).getMonth() === now.getMonth() && new Date(t.createdAt).getFullYear() === now.getFullYear());
                default: return [];
            }
        };

        const archiveUncompletedTasks = async () => {
            const q = query(getTasksCollection());
            const querySnapshot = await getDocs(q);
            const allTasks = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const tasksToUpdate = allTasks.filter(task => {
                if (task.isCompleted || task.frequency === 'uncompleted') return false;
                const taskDate = new Date(task.createdAt);
                if (task.frequency === 'daily' && taskDate < today) return true;
                if (task.frequency === 'weekly' && taskDate < startOfWeek) return true;
                if (task.frequency === 'monthly' && taskDate < startOfMonth) return true;
                return false;
            });

            if (tasksToUpdate.length > 0) {
                const updatePromises = tasksToUpdate.map(t => updateDoc(doc(getTasksCollection(), t.id), { frequency: 'uncompleted' }));
                await Promise.all(updatePromises);
            }
        };
        
        const switchPage = (page) => {
            currentPage = page;
            DOMElements.tasksView.classList.toggle('hidden-view', page !== 'tasks');
            DOMElements.goalsView.classList.toggle('hidden-view', page !== 'goals');
            updateNavStyles();
        };

        const updateNavStyles = () => {
            const activeClass = 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300';
            const inactiveClass = 'text-gray-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700';
            const mobileActiveClass = 'text-blue-600 dark:text-blue-400';
            const mobileInactiveClass = 'text-gray-500 dark:text-gray-300';

            DOMElements.navTasks.className = `px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'tasks' ? activeClass : inactiveClass}`;
            DOMElements.navGoals.className = `px-3 py-2 rounded-md text-sm font-medium ${currentPage === 'goals' ? activeClass : inactiveClass}`;
            DOMElements.mobileNavTasks.className = `flex-1 py-2 text-sm font-medium ${currentPage === 'tasks' ? mobileActiveClass : mobileInactiveClass}`;
            DOMElements.mobileNavGoals.className = `flex-1 py-2 text-sm font-medium ${currentPage === 'goals' ? mobileActiveClass : mobileInactiveClass}`;
        };
        
        const updateTaskViewStyles = () => {
            document.querySelectorAll('.task-view-btn').forEach(btn => {
                btn.classList.toggle('border-b-2', btn.dataset.view === currentTaskView);
                btn.classList.toggle('border-blue-500', btn.dataset.view === currentTaskView);
                btn.classList.toggle('text-blue-500', btn.dataset.view === currentTaskView);
                btn.classList.toggle('text-gray-500', btn.dataset.view !== currentTaskView);
            });
            DOMElements.newTaskInput.placeholder = `Add a new ${currentTaskView} task...`;
            DOMElements.addTaskForm.classList.toggle('hidden', currentTaskView === 'uncompleted');
        };

        const toggleModal = (show) => {
            DOMElements.goalModal.classList.toggle('hidden', !show);
            DOMElements.goalModal.classList.toggle('flex', show);
        };
        
        const handleThemeToggle = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            DOMElements.themeToggle.innerHTML = isDark ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
        };
        
        const setupEventListeners = () => {
            DOMElements.addTaskForm.addEventListener('submit', handleAddTask);
            DOMElements.addGoalForm.addEventListener('submit', handleAddGoal);
            DOMElements.addGoalBtn.addEventListener('click', () => toggleModal(true));
            DOMElements.closeModalBtn.addEventListener('click', () => toggleModal(false));
            DOMElements.cancelModalBtn.addEventListener('click', () => toggleModal(false));
            DOMElements.themeToggle.addEventListener('click', handleThemeToggle);
            DOMElements.logoutBtn.addEventListener('click', () => signOut(auth));
            
            [DOMElements.navTasks, DOMElements.mobileNavTasks].forEach(btn => btn.addEventListener('click', () => switchPage('tasks')));
            [DOMElements.navGoals, DOMElements.mobileNavGoals].forEach(btn => btn.addEventListener('click', () => switchPage('goals')));

            DOMElements.taskViewButtons.addEventListener('click', (e) => {
                if (e.target.matches('.task-view-btn')) {
                    currentTaskView = e.target.dataset.view;
                    updateTaskViewStyles();
                    renderTasks();
                }
            });

            DOMElements.taskList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const { action, id } = button.dataset;
                if (action === 'toggle') handleToggleTask(id);
                if (action === 'delete') handleDeleteTask(id);
            });
            
            DOMElements.goalList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const { action, id } = button.dataset;
                const goalCard = e.target.closest('[data-goal-id]');
                const goalId = goalCard?.dataset.goalId;

                if (action === 'delete-goal') handleDeleteGoal(id);
                if (action === 'toggle-milestone') handleToggleMilestone(goalId, id);
                if (action === 'delete-milestone') handleDeleteMilestone(goalId, id);
            });

            DOMElements.goalList.addEventListener('submit', (e) => {
                if (e.target.matches('.add-milestone-form')) {
                    e.preventDefault();
                    const goalId = e.target.closest('[data-goal-id]').dataset.goalId;
                    const input = e.target.querySelector('.new-milestone-input');
                    const text = input.value.trim();
                    if (text) {
                        handleAddMilestone(goalId, text);
                        input.value = '';
                    }
                }
            });

            // Auth form event listeners
            DOMElements.showRegisterBtn.addEventListener('click', () => {
                DOMElements.loginContainer.classList.add('hidden');
                DOMElements.registerContainer.classList.remove('hidden');
                DOMElements.authError.textContent = '';
            });
            DOMElements.showLoginBtn.addEventListener('click', () => {
                DOMElements.loginContainer.classList.remove('hidden');
                DOMElements.registerContainer.classList.add('hidden');
                DOMElements.authError.textContent = '';
            });

            DOMElements.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = DOMElements.loginForm['login-email'].value;
                const password = DOMElements.loginForm['login-password'].value;
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => DOMElements.authError.textContent = error.message);
            });

            DOMElements.registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = DOMElements.registerForm['register-email'].value;
                const password = DOMElements.registerForm['register-password'].value;
                createUserWithEmailAndPassword(auth, email, password)
                    .catch(error => DOMElements.authError.textContent = error.message);
            });
        };
        
        const initApp = async (user) => {
            userId = user.uid;
            DOMElements.authView.classList.add('hidden-view');
            DOMElements.appView.classList.remove('hidden-view');
            
            switchPage('tasks');
            
            await archiveUncompletedTasks();

            tasksUnsubscribe = onSnapshot(query(getTasksCollection()), (snapshot) => {
                tasks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                if (currentPage === 'tasks') renderTasks();
            });

            goalsUnsubscribe = onSnapshot(query(getGoalsCollection()), async (snapshot) => {
                goals = await Promise.all(snapshot.docs.map(async (goalDoc) => {
                    const milestonesSnapshot = await getDocs(getMilestonesCollection(goalDoc.id));
                    const milestones = milestonesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    milestones.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
                    return { id: goalDoc.id, ...goalDoc.data(), milestones };
                }));
                if (currentPage === 'goals') renderGoals();
            });
            
            updateTaskViewStyles();
        };
        
        const cleanup = () => {
            tasksUnsubscribe();
            goalsUnsubscribe();
            userId = null;
            tasks = [];
            goals = [];
            DOMElements.taskList.innerHTML = '';
            DOMElements.goalList.innerHTML = '';
            DOMElements.appView.classList.add('hidden-view');
            DOMElements.authView.classList.remove('hidden-view');
        };

        // --- App Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            DOMElements.themeToggle.innerHTML = document.documentElement.classList.contains('dark') ? '<i class="fa-solid fa-sun"></i>' : '<i class="fa-solid fa-moon"></i>';
            
            setupEventListeners();
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    initApp(user);
                } else {
                    cleanup();
                }
            });
        });

    </script>
</body>
</html>
