<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Priority Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1F2937 0%, #111827 100%);
        }
        .glass-card {
            background: rgba(31, 41, 55, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45);
        }
        .nav-button {
            transition: all 0.3s ease;
            position: relative;
        }
        .nav-button.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: #2DD4BF; /* Teal accent */
            border-radius: 50%;
        }
        .task-item, .milestone-item, .goal-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 1;
            transform: scale(1);
        }
        .task-item.removing, .milestone-item.removing, .goal-card.removing {
            opacity: 0;
            transform: scale(0.9);
            margin-bottom: -80px; /* Adjust based on item height */
        }
        .progress-bar-bg {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .progress-bar-fg {
            background: linear-gradient(90deg, #2DD4BF, #14B8A6); /* Teal gradient */
            transition: width 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .view-container {
            animation: fadeIn 0.6s ease forwards;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #2DD4BF;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #14B8A6;
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header and Navigation -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-10">
            <h1 class="text-5xl font-extrabold text-white mb-4 sm:mb-0">Priority Tracker</h1>
            <nav class="flex items-center space-x-6 text-lg font-semibold">
                <button id="dashboard-nav" class="nav-button text-gray-300 hover:text-white">Dashboard</button>
                <button id="priorities-nav" class="nav-button active text-gray-300 hover:text-white">Priorities</button>
                <button id="goals-nav" class="nav-button text-gray-300 hover:text-white">Goals</button>
            </nav>
        </header>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="hidden view-container">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <!-- Overall Progress -->
                    <div class="glass-card p-6 flex flex-col items-center justify-center text-center">
                        <h3 class="text-xl font-semibold text-teal-300 mb-2">Overall Progress</h3>
                        <div class="relative w-32 h-32">
                            <canvas id="overall-progress-chart"></canvas>
                            <div id="overall-progress-text" class="absolute inset-0 flex items-center justify-center text-3xl font-bold text-white">0%</div>
                        </div>
                    </div>
                    <!-- Tasks Completed -->
                    <div class="glass-card p-6 flex flex-col items-center justify-center text-center">
                        <h3 class="text-xl font-semibold text-teal-300 mb-2">Tasks Completed</h3>
                        <p class="text-5xl font-bold text-white"><span id="completed-tasks-count">0</span> / <span id="total-tasks-count">0</span></p>
                    </div>
                    <!-- Goals Achieved -->
                    <div class="glass-card p-6 flex flex-col items-center justify-center text-center">
                        <h3 class="text-xl font-semibold text-teal-300 mb-2">Goals Achieved</h3>
                        <p id="goals-achieved-count" class="text-5xl font-bold text-white">0</p>
                    </div>
                    <!-- Productivity Streak -->
                    <div class="glass-card p-6 flex flex-col items-center justify-center text-center">
                        <h3 class="text-xl font-semibold text-teal-300 mb-2">Productivity Streak</h3>
                        <p class="text-5xl font-bold text-white"><span id="productivity-streak-count">0</span> Days</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-semibold text-teal-300 mb-4 text-center">Task Distribution</h3>
                        <canvas id="task-distribution-chart"></canvas>
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-semibold text-teal-300 mb-4 text-center">Focus Areas</h3>
                        <canvas id="focus-areas-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Priorities View -->
            <div id="priorities-view" class="view-container">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Daily Card -->
                     <div class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-sun mr-3 text-teal-300"></i>Today</h2>
                        <div class="flex mb-4">
                            <input type="text" id="daily-task-input" class="flex-grow bg-transparent border-b-2 border-white/30 focus:outline-none focus:border-teal-300 placeholder-white/50" placeholder="New daily priority...">
                            <button data-type="daily" class="add-task-btn ml-3 text-2xl text-gray-400 hover:text-teal-300 transition-colors"><i class="fas fa-plus-circle"></i></button>
                        </div>
                        <ul id="daily-tasks-list" data-type="daily" class="task-list space-y-3 custom-scrollbar max-h-64 overflow-y-auto pr-2"></ul>
                    </div>
                    <!-- Weekly Card -->
                    <div class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-2 flex items-center"><i class="fas fa-calendar-week mr-3 text-teal-300"></i>This Week</h2>
                        <div class="w-full progress-bar-bg rounded-full h-2.5 mb-4"><div id="weekly-progress-bar" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div></div>
                        <div class="flex mb-4">
                            <input type="text" id="weekly-task-input" class="flex-grow bg-transparent border-b-2 border-white/30 focus:outline-none focus:border-teal-300 placeholder-white/50" placeholder="New weekly priority...">
                            <button data-type="weekly" class="add-task-btn ml-3 text-2xl text-gray-400 hover:text-teal-300 transition-colors"><i class="fas fa-plus-circle"></i></button>
                        </div>
                        <ul id="weekly-tasks-list" data-type="weekly" class="task-list space-y-3 custom-scrollbar max-h-64 overflow-y-auto pr-2"></ul>
                    </div>
                    <!-- Monthly Card -->
                    <div class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-2 flex items-center"><i class="fas fa-calendar-alt mr-3 text-teal-300"></i>This Month</h2>
                        <div class="w-full progress-bar-bg rounded-full h-2.5 mb-4"><div id="monthly-progress-bar" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div></div>
                        <div class="flex mb-4">
                            <input type="text" id="monthly-task-input" class="flex-grow bg-transparent border-b-2 border-white/30 focus:outline-none focus:border-teal-300 placeholder-white/50" placeholder="New monthly priority...">
                            <button data-type="monthly" class="add-task-btn ml-3 text-2xl text-gray-400 hover:text-teal-300 transition-colors"><i class="fas fa-plus-circle"></i></button>
                        </div>
                        <ul id="monthly-tasks-list" data-type="monthly" class="task-list space-y-3 custom-scrollbar max-h-64 overflow-y-auto pr-2"></ul>
                    </div>
                </div>

                <!-- Uncompleted & Quote -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                    <div class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-archive mr-3 text-gray-400"></i>Uncompleted</h2>
                        <ul id="uncompleted-tasks-list" class="space-y-3 max-h-48 overflow-y-auto custom-scrollbar pr-2"></ul>
                    </div>
                     <div class="glass-card p-6 flex flex-col justify-center items-center text-center">
                        <h2 class="text-xl font-semibold mb-2 text-teal-300">Quote of the Day</h2>
                        <p id="quote-text" class="text-lg italic text-gray-300">"The secret of getting ahead is getting started."</p>
                        <p id="quote-author" class="mt-2 font-medium text-gray-400">- Mark Twain</p>
                    </div>
                </div>
            </div>

            <!-- Goals View -->
            <div id="goals-view" class="hidden view-container">
                <div class="flex justify-center mb-8">
                    <div class="glass-card p-4 flex items-center">
                        <input type="text" id="new-goal-input" class="flex-grow bg-transparent text-lg border-b-2 border-white/30 focus:outline-none focus:border-teal-300 placeholder-white/50" placeholder="Enter a new life goal...">
                        <button id="add-new-goal-btn" class="ml-4 bg-teal-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-teal-400 transition-colors">Add Goal</button>
                    </div>
                </div>
                <div id="goals-container" class="space-y-8">
                    <!-- Goals will be rendered here -->
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-priority-tracker';

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let userDataUnsubscribe = null;
        let allUserData = {};
        
        // --- Chart Instances ---
        let overallProgressChart, taskDistributionChart, focusAreasChart;

        // --- DOM Element References ---
        const dashboardNav = document.getElementById('dashboard-nav');
        const prioritiesNav = document.getElementById('priorities-nav');
        const goalsNav = document.getElementById('goals-nav');
        const dashboardView = document.getElementById('dashboard-view');
        const prioritiesView = document.getElementById('priorities-view');
        const goalsView = document.getElementById('goals-view');
        const goalsContainer = document.getElementById('goals-container');
        const addNewGoalBtn = document.getElementById('add-new-goal-btn');
        const newGoalInput = document.getElementById('new-goal-input');

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                setupListeners();
                checkAndPerformResets();
                fetchQuote();
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined') { await signInWithCustomToken(auth, __initial_auth_token); } 
                    else { await signInAnonymously(auth); }
                } catch (error) { console.error("Error during sign-in:", error); }
            }
        });

        // --- Navigation ---
        function switchView(viewToShow) {
            dashboardView.classList.toggle('hidden', viewToShow !== 'dashboard');
            prioritiesView.classList.toggle('hidden', viewToShow !== 'priorities');
            goalsView.classList.toggle('hidden', viewToShow !== 'goals');
            dashboardNav.classList.toggle('active', viewToShow === 'dashboard');
            prioritiesNav.classList.toggle('active', viewToShow === 'priorities');
            goalsNav.classList.toggle('active', viewToShow === 'goals');
        }
        dashboardNav.addEventListener('click', () => switchView('dashboard'));
        prioritiesNav.addEventListener('click', () => switchView('priorities'));
        goalsNav.addEventListener('click', () => switchView('goals'));
        
        // Set initial view
        switchView('priorities');

        // --- Data Listener ---
        function setupListeners() {
            if (!userId) return;
            if (userDataUnsubscribe) userDataUnsubscribe();

            const userDocRef = doc(db, "artifacts", appId, "users", userId);
            userDataUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    allUserData = docSnap.data();
                    renderAll();
                } else {
                    const initialData = {
                        dailyTasks: [], weeklyTasks: [], monthlyTasks: [], uncompletedTasks: [],
                        goals: [],
                        lastReset: {
                            daily: new Date().toISOString().split('T')[0],
                            weekly: getWeekNumber(new Date()),
                            monthly: new Date().getMonth()
                        },
                        streak: { count: 0, lastCompletionDate: null }
                    };
                    setDoc(userDocRef, initialData).then(() => {
                        allUserData = initialData;
                        renderAll();
                    });
                }
            });
        }

        // --- Main Render Function ---
        function renderAll() {
            renderTasks('daily', allUserData.dailyTasks || []);
            renderTasks('weekly', allUserData.weeklyTasks || []);
            renderTasks('monthly', allUserData.monthlyTasks || []);
            renderTasks('uncompleted', allUserData.uncompletedTasks || []);
            renderGoals(allUserData.goals || []);
            updateAllProgressBars();
            updateDashboard();
        }

        // --- Task Rendering & Logic ---
        function renderTasks(type, tasks) {
            const listElement = document.getElementById(`${type}-tasks-list`);
            if (!listElement) return;
            listElement.innerHTML = tasks.map(task => `
                <li class="task-item flex items-center justify-between p-3 rounded-lg bg-white/5" data-id="${task.id}">
                    <div class="flex items-center flex-grow">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} class="task-checkbox h-5 w-5 rounded-full border-2 bg-transparent border-white/50 text-teal-400 focus:ring-0 focus:ring-offset-0 cursor-pointer">
                        <span class="ml-4 text-lg ${task.completed ? 'line-through text-gray-400' : ''}">${task.text}</span>
                    </div>
                    ${type !== 'uncompleted' ? `<button class="delete-task-btn text-gray-500 hover:text-red-400 transition-colors text-xl"><i class="fas fa-trash-alt"></i></button>` : ''}
                </li>
            `).join('');
        }
        
        async function updateTasks(type, updatedTasks, completedTaskId = null) {
            const userDocRef = doc(db, "artifacts", appId, "users", userId);
            const updateData = { [`${type}Tasks`]: updatedTasks };

            if (completedTaskId) {
                const today = new Date().toISOString().split('T')[0];
                const streak = allUserData.streak || { count: 0, lastCompletionDate: null };
                const lastDate = streak.lastCompletionDate;

                if (lastDate !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    
                    if (lastDate === yesterdayStr) {
                        streak.count++;
                    } else {
                        streak.count = 1;
                    }
                    streak.lastCompletionDate = today;
                    updateData.streak = streak;
                }
            }
            await updateDoc(userDocRef, updateData);
        }

        function addTask(type) {
            const input = document.getElementById(`${type}-task-input`);
            const text = input.value.trim();
            if (text === '') return;
            const newTask = { id: crypto.randomUUID(), text, completed: false };
            updateTasks(type, [...(allUserData[`${type}Tasks`] || []), newTask]);
            input.value = '';
        }

        // --- Event Delegation for Tasks ---
        prioritiesView.addEventListener('click', (e) => {
            const target = e.target;
            const addBtn = target.closest('.add-task-btn');
            if (addBtn) {
                addTask(addBtn.dataset.type);
                return;
            }
            const taskItem = target.closest('.task-item');
            if (!taskItem) return;
            const taskList = taskItem.closest('.task-list');
            if (!taskList) return;

            const taskId = taskItem.dataset.id;
            const taskType = taskList.dataset.type;

            if (target.matches('.task-checkbox')) {
                const updatedTasks = (allUserData[`${taskType}Tasks`] || []).map(task => 
                    task.id === taskId ? { ...task, completed: target.checked } : task
                );
                updateTasks(taskType, updatedTasks, target.checked ? taskId : null);
            } else if (target.closest('.delete-task-btn')) {
                taskItem.classList.add('removing');
                setTimeout(() => {
                    const updatedTasks = (allUserData[`${taskType}Tasks`] || []).filter(task => task.id !== taskId);
                    updateTasks(taskType, updatedTasks);
                }, 400);
            }
        });

        ['daily', 'weekly', 'monthly'].forEach(type => {
            document.getElementById(`${type}-task-input`).addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(type); });
        });

        // --- Goal & Milestone Rendering & Logic ---
        function renderGoals(goals = []) {
            goalsContainer.innerHTML = goals.map(goal => `
                <div class="goal-card glass-card p-6" data-goal-id="${goal.id}">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-white">${goal.text}</h3>
                        <button class="delete-goal-btn text-gray-500 hover:text-red-400 transition-colors text-xl"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="w-full progress-bar-bg rounded-full h-2.5 mb-4">
                        <div id="milestone-progress-${goal.id}" class="progress-bar-fg h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <ul class="milestones-list space-y-3 mb-4 custom-scrollbar max-h-48 overflow-y-auto pr-2">
                        ${(goal.milestones || []).map(m => `
                            <li class="milestone-item flex items-center justify-between p-2 rounded-lg bg-white/5" data-milestone-id="${m.id}">
                                <div class="flex items-center flex-grow">
                                    <input type="checkbox" ${m.completed ? 'checked' : ''} class="milestone-checkbox h-5 w-5 rounded-full border-2 bg-transparent border-white/50 text-teal-400 focus:ring-0 focus:ring-offset-0 cursor-pointer">
                                    <span class="ml-4 ${m.completed ? 'line-through text-gray-400' : ''}">${m.text}</span>
                                </div>
                                <button class="delete-milestone-btn text-gray-500 hover:text-red-400 transition-colors"><i class="fas fa-trash-alt"></i></button>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="flex mt-4">
                        <input type="text" class="add-milestone-input flex-grow bg-transparent border-b-2 border-white/30 focus:outline-none focus:border-teal-300 placeholder-white/50" placeholder="New milestone...">
                        <button class="add-milestone-btn ml-3 text-2xl text-gray-400 hover:text-teal-300 transition-colors"><i class="fas fa-plus-circle"></i></button>
                    </div>
                </div>
            `).join('');
        }
        
        async function updateGoals(updatedGoals) {
            const userDocRef = doc(db, "artifacts", appId, "users", userId);
            await updateDoc(userDocRef, { goals: updatedGoals });
        }

        // --- Event Delegation for Goals ---
        addNewGoalBtn.addEventListener('click', () => {
            const text = newGoalInput.value.trim();
            if (text === '') return;
            const newGoal = { id: crypto.randomUUID(), text, milestones: [] };
            updateGoals([...(allUserData.goals || []), newGoal]);
            newGoalInput.value = '';
        });
        newGoalInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewGoalBtn.click(); });

        goalsContainer.addEventListener('click', (e) => {
            const target = e.target;
            const goalCard = target.closest('.goal-card');
            if (!goalCard) return;
            const goalId = goalCard.dataset.goalId;

            if (target.closest('.delete-goal-btn')) {
                goalCard.classList.add('removing');
                setTimeout(() => {
                    const updatedGoals = (allUserData.goals || []).filter(g => g.id !== goalId);
                    updateGoals(updatedGoals);
                }, 400);
                return;
            }

            if (target.closest('.add-milestone-btn')) {
                const inputElement = goalCard.querySelector('.add-milestone-input');
                const text = inputElement.value.trim();
                if (text === '') return;
                const newMilestone = { id: crypto.randomUUID(), text, completed: false };
                const updatedGoals = (allUserData.goals || []).map(g => 
                    g.id === goalId ? { ...g, milestones: [...(g.milestones || []), newMilestone] } : g
                );
                updateGoals(updatedGoals);
                inputElement.value = '';
                return;
            }

            const milestoneItem = target.closest('.milestone-item');
            if (!milestoneItem) return;
            const milestoneId = milestoneItem.dataset.milestoneId;

            if (target.matches('.milestone-checkbox')) {
                const updatedGoals = (allUserData.goals || []).map(g => {
                    if (g.id === goalId) {
                        const updatedMilestones = (g.milestones || []).map(m => m.id === milestoneId ? { ...m, completed: target.checked } : m);
                        return { ...g, milestones: updatedMilestones };
                    }
                    return g;
                });
                updateGoals(updatedGoals);
            }
            else if (target.closest('.delete-milestone-btn')) {
                milestoneItem.classList.add('removing');
                setTimeout(() => {
                    const updatedGoals = (allUserData.goals || []).map(g => {
                        if (g.id === goalId) {
                            const updatedMilestones = (g.milestones || []).filter(m => m.id !== milestoneId);
                            return { ...g, milestones: updatedMilestones };
                        }
                        return g;
                    });
                    updateGoals(updatedGoals);
                }, 400);
            }
        });

        goalsContainer.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.matches('.add-milestone-input')) {
                e.target.nextElementSibling.click();
            }
        });

        // --- Progress & Reset ---
        function updateAllProgressBars() {
            ['weekly', 'monthly'].forEach(type => {
                const tasks = allUserData[`${type}Tasks`] || [];
                const percentage = tasks.length > 0 ? (tasks.filter(t => t.completed).length / tasks.length) * 100 : 0;
                const progressBar = document.getElementById(`${type}-progress-bar`);
                if(progressBar) progressBar.style.width = `${percentage}%`;
            });
            (allUserData.goals || []).forEach(goal => {
                const milestones = goal.milestones || [];
                const percentage = milestones.length > 0 ? (milestones.filter(m => m.completed).length / milestones.length) * 100 : 0;
                const progressBar = document.getElementById(`milestone-progress-${goal.id}`);
                if (progressBar) progressBar.style.width = `${percentage}%`;
            });
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        async function checkAndPerformResets() {
            if (!userId) return;
            const userDocRef = doc(db, "artifacts", appId, "users", userId);
            const docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) return;

            const data = docSnap.data();
            const lastReset = data.lastReset || {};
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentWeek = getWeekNumber(now);
            const currentMonth = now.getMonth();
            
            const batch = writeBatch(db);
            let needsUpdate = false;
            let uncompletedTasks = data.uncompletedTasks || [];

            if (lastReset.daily !== today) {
                uncompletedTasks.push(...(data.dailyTasks || []).filter(t => !t.completed).map(t => ({...t, from: 'daily'})));
                batch.update(userDocRef, { dailyTasks: [], "lastReset.daily": today });
                needsUpdate = true;
            }
            if (lastReset.weekly !== currentWeek) {
                uncompletedTasks.push(...(data.weeklyTasks || []).filter(t => !t.completed).map(t => ({...t, from: 'weekly'})));
                batch.update(userDocRef, { weeklyTasks: [], "lastReset.weekly": currentWeek });
                needsUpdate = true;
            }
            if (lastReset.monthly !== currentMonth) {
                uncompletedTasks.push(...(data.monthlyTasks || []).filter(t => !t.completed).map(t => ({...t, from: 'monthly'})));
                batch.update(userDocRef, { monthlyTasks: [], "lastReset.monthly": currentMonth });
                needsUpdate = true;
            }

            if (needsUpdate) {
                batch.update(userDocRef, { uncompletedTasks: uncompletedTasks });
                await batch.commit();
            }
        }

        // --- Dashboard Logic ---
        function updateDashboard() {
            const { dailyTasks = [], weeklyTasks = [], monthlyTasks = [], goals = [], streak = { count: 0 } } = allUserData;
            const allTasks = [...dailyTasks, ...weeklyTasks, ...monthlyTasks];
            
            const completedTasks = allTasks.filter(t => t.completed).length;
            const totalTasks = allTasks.length;
            const overallProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('completed-tasks-count').textContent = completedTasks;
            document.getElementById('total-tasks-count').textContent = totalTasks;
            document.getElementById('overall-progress-text').textContent = `${overallProgress}%`;

            const goalsAchieved = goals.filter(g => (g.milestones || []).length > 0 && (g.milestones || []).every(m => m.completed)).length;
            document.getElementById('goals-achieved-count').textContent = goalsAchieved;
            
            document.getElementById('productivity-streak-count').textContent = streak.count;

            updateCharts(allTasks, dailyTasks, weeklyTasks, monthlyTasks);
        }

        function updateCharts(allTasks, daily, weekly, monthly) {
            const completed = allTasks.filter(t => t.completed).length;
            const pending = allTasks.length - completed;

            // Overall Progress Chart
            const opcCtx = document.getElementById('overall-progress-chart').getContext('2d');
            if(overallProgressChart) overallProgressChart.destroy();
            overallProgressChart = new Chart(opcCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [completed, pending],
                        backgroundColor: ['#2DD4BF', 'rgba(255, 255, 255, 0.1)'],
                        borderWidth: 0,
                        cutout: '80%'
                    }]
                },
                options: { plugins: { tooltip: { enabled: false } } }
            });

            // Task Distribution Chart
            const tdcCtx = document.getElementById('task-distribution-chart').getContext('2d');
            if(taskDistributionChart) taskDistributionChart.destroy();
            taskDistributionChart = new Chart(tdcCtx, {
                type: 'pie',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [completed, pending],
                        backgroundColor: ['#14B8A6', '#374151'],
                        borderColor: '#1F2937',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top', labels: { color: '#D1D5DB' } } }
                }
            });

            // Focus Areas Chart
            const facCtx = document.getElementById('focus-areas-chart').getContext('2d');
            if(focusAreasChart) focusAreasChart.destroy();
            focusAreasChart = new Chart(facCtx, {
                type: 'bar',
                data: {
                    labels: ['Daily', 'Weekly', 'Monthly'],
                    datasets: [{
                        label: 'Total Tasks',
                        data: [daily.length, weekly.length, monthly.length],
                        backgroundColor: ['#2DD4BF', '#14B8A6', '#0D9488'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#9CA3AF', stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#D1D5DB' }, grid: { display: false } }
                    }
                }
            });
        }


        // --- Motivational Quote ---
        const localQuotes = [
            { content: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
            { content: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
            { content: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
            { content: "Everything you’ve ever wanted is on the other side of fear.", author: "George Addair" },
            { content: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" }
        ];

        async function fetchQuote() {
            try {
                const response = await fetch("https://api.quotable.io/random?tags=inspirational|wisdom|success");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                document.getElementById('quote-text').textContent = `"${data.content}"`;
                document.getElementById('quote-author').textContent = `- ${data.author}`;
            } catch (error) {
                console.error("Quote fetch error, falling back to local quotes:", error);
                const randomQuote = localQuotes[Math.floor(Math.random() * localQuotes.length)];
                document.getElementById('quote-text').textContent = `"${randomQuote.content}"`;
                document.getElementById('quote-author').textContent = `- ${randomQuote.author}`;
            }
        }
    </script>
</body>
</html>
